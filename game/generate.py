from dataclasses import dataclass
import os

class File:
    def __init__(self, name) -> None:
        self.name = name
        with open(f"{name}.py") as file:
            self.lines = file.read().splitlines()
        self.priority = 0

    def check_priority(self):
        if self.lines[0].startswith("#priority"):
            self.priority = int(self.lines[0].split("#priority ", 1)[1])

    def check_dependencies(self):
        print(f"{self.name}:")
        for line in self.lines:
            if not line.startswith("from . import"):
                continue

            dependencies = line.split("from . import ", 1)[1]

            for dependency in dependencies.split(", "):
                dependency = dependency.strip()
                print(f"    -- check dependency {dependency}")
                if dependency not in files:
                    raise Exception(f"Dependency for {self.name} not found: '{dependency}.py'")
                files[dependency].set_max_priority(self.priority - 1)

    # set priority to at most the given priority
    def set_max_priority(self, priority):
        self.priority = min(self.priority, priority)
        if self.priority < -999:
            raise Exception(f"Illegal priority for {self.name} - must be in range [-999, 999] to avoid clash with Ren'Py")

    def write(self) -> None:
        print(f"convert {self.name} at priority {self.priority}", end='')
        with open(f"{self.name}.gen.rpy", "w") as file:
            file.write("# THIS FILE WAS GENERATED BY RENPAC! DO NOT MODIFY MANUALLY AS CHANGES MAY BE OVERWRITTEN\n")
            file.write(f"# To make changes, modify {name}.py and run the generator again.\n\n")
            file.write(f"init {self.priority} python:\n")
            for line in self.lines:
                file.write(f"    {line}\n")
        print(f" => {self.name}.gen.rpy ({len(self.lines)} lines)")

files = {}

def check_dependency(line, priority):
    if not line.startswith("from ."):
        return

    dependencies = line.split("from . import ", 1)[1]

def cleanup():
    gen_files = list(filter(lambda file_name: file_name.endswith(".gen.rpy"), os.listdir()))
    print(f"cleaning up {len(gen_files)} files")
    for gen_file_name in gen_files:
        os.remove(gen_file_name)

def indent(depth=1):
    tab = "    "
    for _ in range(depth):
        print(tab, end='')

cleanup()

ignore_list = [ "generate.py" ]
filenames = list(filter(lambda file_name: file_name.endswith(".py") and file_name not in ignore_list, os.listdir()))

if(len(filenames) == 0):
    print("no files!")
    exit()

print(f"** loading files")
priority = 0
for py_file_name in filenames:
    name = os.path.splitext(py_file_name)[0]
    files[name] = File(name)

print(f"** checking manual priorities")
for key in files:
    files[key].check_priority()

print(f"** checking dependencies")
for key in files:
    files[key].check_dependencies()

print(f"** generating {len(files)} files")
for key in files:
    files[key].write()

print("** done")
